{
    "collab_server" : "",
    "contents" : "library(httr)\nlibrary(jsonlite)\nlibrary(plyr)\nlibrary(dplyr)\nlibrary(grid)\nlibrary(lubridate)\nlibrary(ggplot2)\nlibrary(scales)\nlibrary(gridExtra)\nlibrary(zoo)\nlibrary(reshape2)\nlibrary(tidyr)\n\n#recebe lista de contatos do hubspot e retorna tabela com propriedades a partir disto\ntoTable <- function(APIKEY,hubscontent){\n    colunas = 42\n    final<- data.frame(matrix(ncol=colunas))\n    names(final)<-c(\"email\",\"account_id\",\"lead_source_geral_new\",\"lead_source_new\",\"hubspot_owner_id\",\"opp_new_date\",\"lifecyclestage\",\"deal_stage\",\"became_customer_new\"\n                    ,\"lost_reason\",\"tpv_novo_comercial\",\"condition\",\"faturamento_grupo\",\"reuniao_date\",\"prim_contato_date\",\"qualificado_date\",\"prop_enviada_date\"\n                    ,\"prop_aceita_date\",\"em_integracao_date\",\"integrado_date\",\"convertido_date\",\"nao_e_pra_agora_date\",\"perdido_date\",\"hs_lifecyclestage_lead_date\"\n                    ,\"hs_lifecyclestage_marketingqualifiedlead_date\",\"ecommerce_platform\",\"hubspotscore\",\"receita_ano\",\"receita_mes\",\"receita_total\",\"total_tpv\"\n                    ,\"tpv_ano\",\"tpv_anteontem\",\"tpv_ontem\",\"tpv_max\",\"tpv_mes\",\"tpv_mes_1\",\"tpv_mes_2\",\"tpv_mes_3\",\"monthly_revenue\",\"resposta_inicial\",\"lastmodifieddate\")\n    for(i in 1:length(hubscontent)){\n        final[i,]<-NA\n        final[i,1] <- ifelse(is.null(hubscontent[[i]]$properties$email$value),NA,hubscontent[[i]]$properties$email$value)\n        final[i,2] <- ifelse(is.null(hubscontent[[i]]$properties$account_id$value),NA,as.numeric(hubscontent[[i]]$properties$account_id$value))\n        final[i,3] <- ifelse(is.null(hubscontent[[i]]$properties$lead_source_geral_new$value),NA,hubscontent[[i]]$properties$lead_source_geral_new$value)\n        final[i,4] <- ifelse(is.null(hubscontent[[i]]$properties$lead_source_new$value),NA,hubscontent[[i]]$properties$lead_source_new$value)\n        final[i,5] <- ifelse(is.null(hubscontent[[i]]$properties$hubspot_owner_id$value),NA,hubscontent[[i]]$properties$hubspot_owner_id$value)\n        final[i,6] <- ifelse(is.null(hubscontent[[i]]$properties$opp_new_date$value),NA,hubscontent[[i]]$properties$opp_new_date$value)\n        final[i,7] <- ifelse(is.null(hubscontent[[i]]$properties$lifecyclestage$value),NA,hubscontent[[i]]$properties$lifecyclestage$value)\n        final[i,8] <- ifelse(is.null(hubscontent[[i]]$properties$deal_stage$value),NA,hubscontent[[i]]$properties$deal_stage$value)\n        final[i,9] <- ifelse(is.null(hubscontent[[i]]$properties$became_customer_new$value),NA,hubscontent[[i]]$properties$became_customer_new$value)\n        final[i,10] <- ifelse(is.null(hubscontent[[i]]$properties$lost_reason$value),NA,hubscontent[[i]]$properties$lost_reason$value)\n        final[i,11] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_novo_comercial$value),NA,hubscontent[[i]]$properties$tpv_novo_comercial$value)\n        final[i,12] <- ifelse(is.null(hubscontent[[i]]$properties$condition$value),NA,hubscontent[[i]]$properties$condition$value)\n        final[i,13] <- ifelse(is.null(hubscontent[[i]]$properties$faturamento_grupo$value),NA,hubscontent[[i]]$properties$faturamento_grupo$value)\n        final[i,14] <- ifelse(is.null(hubscontent[[i]]$properties$reuniao_date$value),NA,hubscontent[[i]]$properties$reuniao_date$value)\n        final[i,15] <- ifelse(is.null(hubscontent[[i]]$properties$prim_contato_date$value),NA,hubscontent[[i]]$properties$prim_contato_date$value)\n        final[i,16] <- ifelse(is.null(hubscontent[[i]]$properties$qualificado_date$value),NA,hubscontent[[i]]$properties$qualificado_date$value)\n        final[i,17] <- ifelse(is.null(hubscontent[[i]]$properties$prop_enviada_date$value),NA,hubscontent[[i]]$properties$prop_enviada_date$value)\n        final[i,18] <- ifelse(is.null(hubscontent[[i]]$properties$prop_aceita_date$value),NA,hubscontent[[i]]$properties$prop_aceita_date$value)\n        final[i,19] <- ifelse(is.null(hubscontent[[i]]$properties$em_integracao_date$value),NA,hubscontent[[i]]$properties$em_integracao_date$value)\n        final[i,20] <- ifelse(is.null(hubscontent[[i]]$properties$integrado_date$value),NA,hubscontent[[i]]$properties$integrado_date$value)\n        final[i,21] <- ifelse(is.null(hubscontent[[i]]$properties$convertido_date$value),NA,hubscontent[[i]]$properties$convertido_date$value)\n        final[i,22] <- ifelse(is.null(hubscontent[[i]]$properties$nao_e_pra_agora_date$value),NA,hubscontent[[i]]$properties$nao_e_pra_agora_date$value)\n        final[i,23] <- ifelse(is.null(hubscontent[[i]]$properties$perdido_date$value),NA,hubscontent[[i]]$properties$perdido_date$value)\n        final[i,24] <- ifelse(is.null(hubscontent[[i]]$properties$hs_lifecyclestage_lead_date$value),NA,hubscontent[[i]]$properties$hs_lifecyclestage_lead_date$value)\n        final[i,25] <- ifelse(is.null(hubscontent[[i]]$properties$hs_lifecyclestage_marketingqualifiedlead_date$value),NA,hubscontent[[i]]$properties$hs_lifecyclestage_marketingqualifiedlead_date$value)\n        final[i,26] <- ifelse(is.null(hubscontent[[i]]$properties$ecommerce_platform$value),NA,hubscontent[[i]]$properties$ecommerce_platform$value)\n        final[i,27] <- ifelse(is.null(hubscontent[[i]]$properties$hubspotscore$value),NA,as.numeric(hubscontent[[i]]$properties$hubspotscore$value))\n        final[i,28] <- ifelse(is.null(hubscontent[[i]]$properties$receita_ano$value),NA,as.numeric(hubscontent[[i]]$properties$receita_ano$value))\n        final[i,29] <- ifelse(is.null(hubscontent[[i]]$properties$receita_mes$value),NA,as.numeric(hubscontent[[i]]$properties$receita_mes$value))\n        final[i,30] <- ifelse(is.null(hubscontent[[i]]$properties$receita_total$value),NA,as.numeric(hubscontent[[i]]$properties$receita_total$value))\n        final[i,31] <- ifelse(is.null(hubscontent[[i]]$properties$total_tpv$value),NA,as.numeric(hubscontent[[i]]$properties$total_tpv$value))\n        final[i,32] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_ano$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_ano$value))\n        final[i,33] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_anteontem$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_anteontem$value))\n        final[i,34] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_ontem$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_ontem$value))\n        final[i,35] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_max$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_max$value))\n        final[i,36] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_mes$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_mes$value))\n        final[i,37] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_mes_1$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_mes_1$value))\n        final[i,38] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_mes_2$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_mes_2$value))\n        final[i,39] <- ifelse(is.null(hubscontent[[i]]$properties$tpv_mes_3$value),NA,as.numeric(hubscontent[[i]]$properties$tpv_mes_3$value))\n        final[i,40] <- ifelse(is.null(hubscontent[[i]]$properties$monthly_revenue$value),NA,hubscontent[[i]]$properties$monthly_revenue$value)\n        final[i,41] <- ifelse(is.null(hubscontent[[i]]$properties$resposta_inicial$value),NA,hubscontent[[i]]$properties$resposta_inicial$value)\n        final[i,42] <- ifelse(is.null(hubscontent[[i]]$properties$lastmodifieddate$value),NA,hubscontent[[i]]$properties$lastmodifieddate$value)\n    }\n    #add owners name and email\n    owners <- getOwners(APIKEY)\n    final <- merge(final, owners, by = \"hubspot_owner_id\", all.x = TRUE)\n\n    #arrange the dates\n    final$opp_new_date<-as.Date(as.POSIXlt(as.numeric(final$opp_new_date)/1000, origin=\"1970-01-01\"))\n    final$became_customer_new<-as.Date(as.POSIXlt(as.numeric(final$became_customer_new)/1000, origin=\"1970-01-01\"))\n    final$reuniao_date<-as.Date(as.POSIXlt(as.numeric(final$reuniao_date)/1000, origin=\"1970-01-01\"))\n    final$prim_contato_date<-as.Date(as.POSIXlt(as.numeric(final$prim_contato_date)/1000, origin=\"1970-01-01\"))\n    final$qualificado_date<-as.Date(as.POSIXlt(as.numeric(final$qualificado_date)/1000, origin=\"1970-01-01\"))\n    final$prop_enviada_date<-as.Date(as.POSIXlt(as.numeric(final$prop_enviada_date)/1000, origin=\"1970-01-01\"))\n    final$prop_aceita_date<-as.Date(as.POSIXlt(as.numeric(final$prop_aceita_date)/1000, origin=\"1970-01-01\"))\n    final$em_integracao_date<-as.Date(as.POSIXlt(as.numeric(final$em_integracao_date)/1000, origin=\"1970-01-01\"))\n    final$integrado_date<-as.Date(as.POSIXlt(as.numeric(final$integrado_date)/1000, origin=\"1970-01-01\"))\n    final$convertido_date<-as.Date(as.POSIXlt(as.numeric(final$convertido_date)/1000, origin=\"1970-01-01\"))\n    final$nao_e_pra_agora_date<-as.Date(as.POSIXlt(as.numeric(final$nao_e_pra_agora_date)/1000, origin=\"1970-01-01\"))\n    final$perdido_date<-as.Date(as.POSIXlt(as.numeric(final$perdido_date)/1000, origin=\"1970-01-01\"))\n    final$hs_lifecyclestage_lead_date<-as.Date(as.POSIXlt(as.numeric(final$hs_lifecyclestage_lead_date)/1000, origin=\"1970-01-01\"))\n    final$hs_lifecyclestage_marketingqualifiedlead_date<-as.Date(as.POSIXlt(as.numeric(final$hs_lifecyclestage_marketingqualifiedlead_date)/1000, origin=\"1970-01-01\"))\n    final$lastmodifieddate<-as.Date(as.POSIXlt(as.numeric(final$lastmodifieddate)/1000, origin=\"1970-01-01\"))\n\n    return(final)\n}\n\n#retorna tabela de IDs do hubspot com seus respectivos owners e emails\ngetOwners <- function(APIKEY){\n    APIKEY_VALUE <- APIKEY\n    HS_API_URL <- \"http://api.hubapi.com\"\n    APIKEY <- paste(\"?hapikey=\", APIKEY_VALUE,sep=\"\")\n    xulr <-\"/owners/v2/owners/\"\n\n    url <- paste(HS_API_URL, xulr, APIKEY,sep=\"\")\n\n    #raw.result <- GET(url = url)\n    #this.raw.content <- rawToChar(raw.result$content)\n    this.raw.content <- content(GET(url = url), \"text\")\n    this.content <- fromJSON(this.raw.content)\n\n    hubspot_owner_id<-this.content$ownerId\n    hubspot_owner_name<-paste(this.content$firstName,this.content$lastName)\n    hubspot_owner_email<-this.content$email\n    owners<-data.frame(hubspot_owner_id,hubspot_owner_name,hubspot_owner_email)\n    return(owners)\n}\n\n#arruma data de contatos\narrangeDate <- function(contatosHub){\n\n    #garantir que tds contatos com data tenham opp data\n    min <- as.Date(apply(contatosHub[,c(which(names(contatosHub)==\"prim_contato_date\"),which(names(contatosHub)==\"qualificado_date\"),which(names(contatosHub)==\"prop_enviada_date\"),\n                                        which(names(contatosHub)==\"prop_aceita_date\"),which(names(contatosHub)==\"em_integracao_date\"),which(names(contatosHub)==\"integrado_date\"),\n                                        which(names(contatosHub)==\"convertido_date\"),\n                                        which(names(contatosHub)==\"nao_e_pra_agora_date\"),\n                                        which(names(contatosHub)==\"perdido_date\"))], 1, min,na.rm = TRUE))\n    contatosHub$opp_new_date[is.na(contatosHub$reuniao_date)  & is.na(contatosHub$opp_new_date) & !is.na(min)] <- min [is.na(contatosHub$reuniao_date)\n                                                                                                                       & is.na(contatosHub$opp_new_date) & !is.na(min)]\n\n    #garantir que reuniao seja maior entre reuniao e opp\n    contatosHub$reuniao_date <- as.Date(apply(contatosHub[,c(which(names(contatosHub)==\"opp_new_date\"),which(names(contatosHub)==\"reuniao_date\"))],\n                                              1, max,na.rm = TRUE))\n\n    #colocar NA em contatos com #convertido# date menor que reuniao\n    contatosHub$convertido_date[!is.na(contatosHub$reuniao_date) &\n                                    !is.na(contatosHub$convertido_date) &\n                                    contatosHub$reuniao_date>contatosHub$convertido_date] <- NA\n\n    #colocar NA em contatos com #integrado# date menor que reuniao e colocar a data de convertido em integrado com NA mas com convertido date\n    contatosHub$integrado_date[!is.na(contatosHub$reuniao_date) &\n                                   !is.na(contatosHub$integrado_date) &\n                                   contatosHub$reuniao_date>contatosHub$integrado_date] <- NA\n    contatosHub$integrado_date[is.na(contatosHub$integrado_date) &\n                                   !is.na(contatosHub$convertido_date)] <- contatosHub$convertido_date[is.na(contatosHub$integrado_date) &\n                                                                                                           !is.na(contatosHub$convertido_date)]\n    #repetir para em integracao\n    contatosHub$em_integracao_date[!is.na(contatosHub$reuniao_date) &\n                                       !is.na(contatosHub$em_integracao_date) &\n                                       contatosHub$reuniao_date>contatosHub$em_integracao_date] <- NA\n    contatosHub$em_integracao_date[is.na(contatosHub$em_integracao_date) &\n                                       !is.na(contatosHub$integrado_date)] <- contatosHub$integrado_date[is.na(contatosHub$em_integracao_date) &\n                                                                                                             !is.na(contatosHub$integrado_date)]\n    #repetir para em prop aceita\n    contatosHub$prop_aceita_date[!is.na(contatosHub$reuniao_date) &\n                                     !is.na(contatosHub$prop_aceita_date) &\n                                     contatosHub$reuniao_date>contatosHub$prop_aceita_date] <- NA\n    contatosHub$prop_aceita_date[is.na(contatosHub$prop_aceita_date) &\n                                     !is.na(contatosHub$em_integracao_date)] <- contatosHub$em_integracao_date[is.na(contatosHub$prop_aceita_date) &\n                                                                                                                   !is.na(contatosHub$em_integracao_date)]\n\n    #repetir para em prop enviada\n    contatosHub$prop_enviada_date[!is.na(contatosHub$reuniao_date) &\n                                      !is.na(contatosHub$prop_enviada_date) &\n                                      contatosHub$reuniao_date>contatosHub$prop_enviada_date] <- NA\n    contatosHub$prop_enviada_date[is.na(contatosHub$prop_enviada_date) &\n                                      !is.na(contatosHub$prop_aceita_date)] <- contatosHub$prop_aceita_date[is.na(contatosHub$prop_enviada_date) &\n                                                                                                                !is.na(contatosHub$prop_aceita_date)]\n    #repetir para qualificado\n    contatosHub$qualificado_date[!is.na(contatosHub$reuniao_date) &\n                                     !is.na(contatosHub$qualificado_date) &\n                                     contatosHub$reuniao_date>contatosHub$qualificado_date] <- NA\n    contatosHub$qualificado_date[is.na(contatosHub$qualificado_date) &\n                                     !is.na(contatosHub$prop_enviada_date)] <- contatosHub$prop_enviada_date[is.na(contatosHub$qualificado_date) &\n                                                                                                                 !is.na(contatosHub$prop_enviada_date)]\n\n    #repetir para prim contato\n    contatosHub$prim_contato_date[!is.na(contatosHub$reuniao_date) &\n                                      !is.na(contatosHub$prim_contato_date) &\n                                      contatosHub$reuniao_date>contatosHub$prim_contato_date] <- NA\n    contatosHub$prim_contato_date[is.na(contatosHub$prim_contato_date) &\n                                      !is.na(contatosHub$qualificado_date)] <- contatosHub$qualificado_date[is.na(contatosHub$prim_contato_date) &\n                                                                                                                !is.na(contatosHub$qualificado_date)]\n    return(contatosHub)\n}\n\n#retorna lista de contatos do Hubspot a partir de uma ID de lista\ngetHubspotContacts <- function(APIKEY, listID=\"2133\"){\n    ###############################\n    ###############################\n    #API key\n    APIKEY_VALUE <- APIKEY\n    HS_API_URL <- \"http://api.hubapi.com\"\n\n    ###############################\n    ###############################\n    #get all vIDs from list id\n\n\n    has.more=TRUE\n    NMAX = 400\n    n=1\n    vidOffset=0\n    vids<-list()\n    contactslist<-list()\n\n    while(has.more==TRUE & n<=NMAX){\n\n        #pega vIDs\n        APIKEY <- paste(\"?hapikey=\", APIKEY_VALUE,\"&count=250&vidOffset=\",vidOffset,sep=\"\")\n        xulr <- paste(\"/contacts/v1/lists/\",listID,\"/contacts/all\",sep=\"\")\n\n        url <- paste(HS_API_URL, xulr, APIKEY,sep=\"\")\n\n        this.raw.content <- content(GET(url = url), \"text\")\n        this.content <- fromJSON(this.raw.content)\n\n        vidOffset<-this.content$`vid-offset`\n        has.more<- this.content$`has-more`\n\n        vids[[n]]<-this.content$contacts$vid\n        vec<-unlist(vids[[n]])\n\n        #pega Contatos\n        vidsV<-paste(\"vid=\",vec,sep=\"\",collapse = \"&\")\n        xulr <-\"/contacts/v1/contact/vids/batch/?\"\n\n        APIKEY <- paste(\"&hapikey=\", APIKEY_VALUE,sep=\"\")\n\n        url <- paste(HS_API_URL, xulr, vidsV, APIKEY,sep=\"\")\n\n        this.raw.content <- content(GET(url = url), \"text\")\n        this.content <- fromJSON(this.raw.content)\n\n        contactslist[[n]]<-toTable(APIKEY = APIKEY_VALUE, hubscontent = this.content)\n\n        n<-n+1\n    }\n\n    contactsFunil <- ldply(contactslist, data.frame)\n\n    return (contactsFunil)\n    ### time ###\n    end.time <- Sys.time()\n    time.taken <- end.time - start.time\n    time.taken\n}\n\n#cria tabela com numeros em cada etapa do funil\ncriaFunilComercial <- function (contatos, vendedor = \"all\", lead_source_geral = \"all\", lead_source = \"all\", type = \"safra\", ecommerce_platform = \"all\",\n                                dataRef = NULL, Q = NULL, dataFinal = NULL){\n    ## set vectors for all option ##\n    if (vendedor == \"all\"){\n        vendedor <- unique(contatos$hubspot_owner_name)\n    }\n    if (lead_source_geral == \"all\"){\n        lead_source_geral <- unique(contatos$lead_source_geral_new)\n    }\n    if (lead_source == \"all\"){\n        lead_source <- unique(contatos$lead_source_new)\n    }\n    if (ecommerce_platform == \"all\"){\n        ecommerce_platform <- unique(contatos$ecommerce_platform)\n    }\n    #arrange contacts dates\n    #contatosD <- suppressWarnings(arrangeDate (contatos))\n    contatosD <- contatos\n    ## visao do mes ##\n    if (type == \"mes\"){\n        if (is.null(dataRef)){\n            dataRef <- as.Date(paste(year(now()),\"-\",month(now()),\"-01\",sep=\"\"))\n        }else{\n            dataRef <- as.Date(paste(year(dataRef),\"-\",month(dataRef),\"-01\",sep=\"\"))\n        }\n\n        dataFinal <- as.Date(paste(year(dataRef),\"-\",month(dataRef)+1,\"-01\",sep=\"\"))\n\n        reuniao <- length(which(!is.na(contatosD$reuniao_date) &\n                                    (contatosD$reuniao_date>=dataRef) &\n                                    (contatosD$reuniao_date<dataFinal) &\n                                    contatosD$hubspot_owner_name%in%vendedor &\n                                    contatosD$lead_source_geral_new%in%lead_source_geral &\n                                    contatosD$lead_source_new%in%lead_source &\n                                    contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        pcontato <- length(which(!is.na(contatosD$prim_contato_date) &\n                                     (contatosD$prim_contato_date>=dataRef) &\n                                     (contatosD$prim_contato_date<dataFinal) &\n                                     contatosD$hubspot_owner_name%in%vendedor &\n                                     contatosD$lead_source_geral_new%in%lead_source_geral &\n                                     contatosD$lead_source_new%in%lead_source &\n                                     contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        qualificado <- length(which(!is.na(contatosD$qualificado_date) &\n                                        (contatosD$qualificado_date>=dataRef) &\n                                        (contatosD$qualificado_date<dataFinal) &\n                                        contatosD$hubspot_owner_name%in%vendedor &\n                                        contatosD$lead_source_geral_new%in%lead_source_geral &\n                                        contatosD$lead_source_new%in%lead_source &\n                                        contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        penviada <- length(which(!is.na(contatosD$prop_enviada_date) &\n                                     (contatosD$prop_enviada_date>=dataRef) &\n                                     (contatosD$prop_enviada_date<dataFinal) &\n                                     contatosD$hubspot_owner_name%in%vendedor &\n                                     contatosD$lead_source_geral_new%in%lead_source_geral &\n                                     contatosD$lead_source_new%in%lead_source &\n                                     contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        paceita <- length(which(!is.na(contatosD$prop_aceita_date) &\n                                    (contatosD$prop_aceita_date>=dataRef) &\n                                    (contatosD$prop_aceita_date<dataFinal) &\n                                    contatosD$hubspot_owner_name%in%vendedor &\n                                    contatosD$lead_source_geral_new%in%lead_source_geral &\n                                    contatosD$lead_source_new%in%lead_source &\n                                    contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        emintegracao <- length(which(!is.na(contatosD$em_integracao_date) &\n                                         (contatosD$em_integracao_date>=dataRef) &\n                                         (contatosD$em_integracao_date<dataFinal) &\n                                         contatosD$hubspot_owner_name%in%vendedor &\n                                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                                         contatosD$lead_source_new%in%lead_source &\n                                         contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        integrado <- length(which(!is.na(contatosD$integrado_date) &\n                                      (contatosD$integrado_date>=dataRef) &\n                                      (contatosD$integrado_date<dataFinal) &\n                                      contatosD$hubspot_owner_name%in%vendedor &\n                                      contatosD$lead_source_geral_new%in%lead_source_geral &\n                                      contatosD$lead_source_new%in%lead_source &\n                                      contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        convertido <- length(which(!is.na(contatosD$convertido_date) &\n                                       (contatosD$convertido_date>=dataRef) &\n                                       (contatosD$convertido_date<dataFinal) &\n                                       contatosD$hubspot_owner_name%in%vendedor &\n                                       contatosD$lead_source_geral_new%in%lead_source_geral &\n                                       contatosD$lead_source_new%in%lead_source &\n                                       contatosD$ecommerce_platform%in%ecommerce_platform &\n                                       contatos$deal_stage==\"Convertido\"))\n    }\n    ## visao de trimestral ##\n    else if (type == \"tri\"){\n\n        if (is.null(dataRef)){\n            if (is.null(Q)){\n                Q <- quarter(now())\n            }\n            if (Q == 1){\n                dataRef <- as.Date(paste(year(now()),\"-01-01\",sep=\"\"))\n            }else if (Q == 2){\n                dataRef <- as.Date(paste(year(now()),\"-04-01\",sep=\"\"))\n            }else if (Q == 3){\n                dataRef <- as.Date(paste(year(now()),\"-07-01\",sep=\"\"))\n            }else {\n                dataRef <- as.Date(paste(year(now()),\"-10-01\",sep=\"\"))\n            }\n        }\n        else if (!is.null(dataRef)){\n            if (is.null(Q)){\n               Q <- quarter(dataRef)\n            }\n            if (Q == 1){\n                dataRef <- as.Date(paste(year(dataRef),\"-01-01\",sep=\"\"))\n            }else if (Q == 2){\n                dataRef <- as.Date(paste(year(dataRef),\"-04-01\",sep=\"\"))\n            }else if (Q == 3){\n                dataRef <- as.Date(paste(year(dataRef),\"-07-01\",sep=\"\"))\n            }else {\n                dataRef <- as.Date(paste(year(dataRef),\"-10-01\",sep=\"\"))\n            }\n        }\n\n        dataFinal <- dataRef\n        month(dataFinal) <- month(dataRef) + 2\n        day(dataFinal) <- days_in_month(dataFinal)\n\n        reuniao <- length(which(!is.na(contatosD$reuniao_date) &\n                                    (contatosD$reuniao_date>=dataRef) &\n                                    (contatosD$reuniao_date<=dataFinal) &\n                                    contatosD$hubspot_owner_name%in%vendedor &\n                                    contatosD$lead_source_geral_new%in%lead_source_geral &\n                                    contatosD$lead_source_new%in%lead_source &\n                                    contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        pcontato <- length(which(!is.na(contatosD$prim_contato_date) &\n                                     (contatosD$prim_contato_date>=dataRef) &\n                                     (contatosD$prim_contato_date<=dataFinal) &\n                                     contatosD$hubspot_owner_name%in%vendedor &\n                                     contatosD$lead_source_geral_new%in%lead_source_geral &\n                                     contatosD$lead_source_new%in%lead_source &\n                                     contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        qualificado <- length(which(!is.na(contatosD$qualificado_date) &\n                                        (contatosD$qualificado_date>=dataRef) &\n                                        (contatosD$qualificado_date<=dataFinal) &\n                                        contatosD$hubspot_owner_name%in%vendedor &\n                                        contatosD$lead_source_geral_new%in%lead_source_geral &\n                                        contatosD$lead_source_new%in%lead_source &\n                                        contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        penviada <- length(which(!is.na(contatosD$prop_enviada_date) &\n                                     (contatosD$prop_enviada_date>=dataRef) &\n                                     (contatosD$prop_enviada_date<=dataFinal) &\n                                     contatosD$hubspot_owner_name%in%vendedor &\n                                     contatosD$lead_source_geral_new%in%lead_source_geral &\n                                     contatosD$lead_source_new%in%lead_source &\n                                     contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        paceita <- length(which(!is.na(contatosD$prop_aceita_date) &\n                                    (contatosD$prop_aceita_date>=dataRef) &\n                                    (contatosD$prop_aceita_date<=dataFinal) &\n                                    contatosD$hubspot_owner_name%in%vendedor &\n                                    contatosD$lead_source_geral_new%in%lead_source_geral &\n                                    contatosD$lead_source_new%in%lead_source &\n                                    contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        emintegracao <- length(which(!is.na(contatosD$em_integracao_date) &\n                                         (contatosD$em_integracao_date>=dataRef) &\n                                         (contatosD$em_integracao_date<=dataFinal) &\n                                         contatosD$hubspot_owner_name%in%vendedor &\n                                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                                         contatosD$lead_source_new%in%lead_source &\n                                         contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        integrado <- length(which(!is.na(contatosD$integrado_date) &\n                                      (contatosD$integrado_date>=dataRef) &\n                                      (contatosD$integrado_date<=dataFinal) &\n                                      contatosD$hubspot_owner_name%in%vendedor &\n                                      contatosD$lead_source_geral_new%in%lead_source_geral &\n                                      contatosD$lead_source_new%in%lead_source &\n                                      contatosD$ecommerce_platform%in%ecommerce_platform))\n\n        convertido <- length(which(!is.na(contatosD$convertido_date) &\n                                       (contatosD$convertido_date>=dataRef) &\n                                       (contatosD$convertido_date<=dataFinal) &\n                                       contatosD$hubspot_owner_name%in%vendedor &\n                                       contatosD$lead_source_geral_new%in%lead_source_geral &\n                                       contatosD$lead_source_new%in%lead_source &\n                                       contatosD$ecommerce_platform%in%ecommerce_platform &\n                                       contatos$deal_stage==\"Convertido\"))\n\n    }\n    ## visao de safra ##\n    else {\n        if (is.null(dataRef)){\n            dataRef <- as.Date(paste(year(now()),\"-01-01\",sep=\"\"))\n        }\n        if (is.null(dataFinal)){\n          dataFinal <- as.Date(paste(year(dataRef),\"-12-31\",sep=\"\"))\n        }\n\n      reuniao <- length(which(!is.na(contatosD$reuniao_date) &\n                                contatosD$reuniao_date>=dataRef &\n                                contatosD$reuniao_date<=dataFinal &\n                                contatosD$hubspot_owner_name%in%vendedor &\n                                contatosD$lead_source_geral_new%in%lead_source_geral &\n                                contatosD$lead_source_new%in%lead_source &\n                                contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      pcontato <- length(which(!is.na(contatosD$reuniao_date) &\n                                 contatosD$reuniao_date>=dataRef &\n                                 contatosD$reuniao_date<=dataFinal &\n                                 !is.na(contatosD$prim_contato_date) &\n                                 contatosD$prim_contato_date>=dataRef &\n                                 contatosD$prim_contato_date<=dataFinal &\n                                 contatosD$hubspot_owner_name%in%vendedor &\n                                 contatosD$lead_source_geral_new%in%lead_source_geral &\n                                 contatosD$lead_source_new%in%lead_source &\n                                 contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      qualificado <- length(which(!is.na(contatosD$reuniao_date) &\n                                    contatosD$reuniao_date>=dataRef &\n                                    contatosD$reuniao_date<=dataFinal &\n                                    !is.na(contatosD$qualificado_date) &\n                                    contatosD$qualificado_date>=dataRef &\n                                    contatosD$qualificado_date<=dataFinal &\n                                    contatosD$hubspot_owner_name%in%vendedor &\n                                    contatosD$lead_source_geral_new%in%lead_source_geral &\n                                    contatosD$lead_source_new%in%lead_source &\n                                    contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      penviada <- length(which(!is.na(contatosD$reuniao_date) &\n                                 contatosD$reuniao_date>=dataRef &\n                                 contatosD$reuniao_date<=dataFinal &\n                                 !is.na(contatosD$prop_enviada_date) &\n                                 contatosD$prop_enviada_date>=dataRef &\n                                 contatosD$prop_enviada_date<=dataFinal &\n                                 contatosD$hubspot_owner_name%in%vendedor &\n                                 contatosD$lead_source_geral_new%in%lead_source_geral &\n                                 contatosD$lead_source_new%in%lead_source &\n                                 contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      paceita <- length(which(!is.na(contatosD$reuniao_date) &\n                                contatosD$reuniao_date>=dataRef &\n                                contatosD$reuniao_date<=dataFinal &\n                                !is.na(contatosD$prop_aceita_date) &\n                                contatosD$prop_aceita_date>=dataRef &\n                                contatosD$prop_aceita_date<=dataFinal &\n                                contatosD$hubspot_owner_name%in%vendedor &\n                                contatosD$lead_source_geral_new%in%lead_source_geral &\n                                contatosD$lead_source_new%in%lead_source &\n                                contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      emintegracao <- length(which(!is.na(contatosD$reuniao_date) &\n                                     contatosD$reuniao_date>=dataRef &\n                                     contatosD$reuniao_date<=dataFinal &\n                                     !is.na(contatosD$em_integracao_date) &\n                                     contatosD$em_integracao_date>=dataRef &\n                                     contatosD$em_integracao_date<=dataFinal &\n                                     contatosD$hubspot_owner_name%in%vendedor &\n                                     contatosD$lead_source_geral_new%in%lead_source_geral &\n                                     contatosD$lead_source_new%in%lead_source &\n                                     contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      integrado <- length(which(!is.na(contatosD$reuniao_date) &\n                                  contatosD$reuniao_date>=dataRef &\n                                  contatosD$reuniao_date<=dataFinal &\n                                  !is.na(contatosD$integrado_date) &\n                                  contatosD$integrado_date>=dataRef &\n                                  contatosD$integrado_date<=dataFinal &\n                                  contatosD$hubspot_owner_name%in%vendedor &\n                                  contatosD$lead_source_geral_new%in%lead_source_geral &\n                                  contatosD$lead_source_new%in%lead_source &\n                                  contatosD$ecommerce_platform%in%ecommerce_platform))\n\n      convertido <- length(which(!is.na(contatosD$reuniao_date) &\n                                   contatosD$reuniao_date>=dataRef &\n                                   contatosD$reuniao_date<=dataFinal &\n                                   !is.na(contatosD$convertido_date) &\n                                   contatosD$convertido_date>=dataRef &\n                                   contatosD$convertido_date<=dataFinal &\n                                   contatosD$hubspot_owner_name%in%vendedor &\n                                   contatosD$lead_source_geral_new%in%lead_source_geral &\n                                   contatosD$lead_source_new%in%lead_source &\n                                   contatosD$ecommerce_platform%in%ecommerce_platform &\n                                   contatos$deal_stage==\"Convertido\"))\n    }\n\n    final <- data.frame(deal_stage = c(\"Reuniao\",\"Primeiro Contato\",\"Qualificado\",\"Proposta Enviada\",\"Proposta Aceita\",\"Em Integracao\",\"Integrado\",\"Convertido\"),\n                        ncontacts = c(reuniao,pcontato,qualificado,penviada,paceita,emintegracao,integrado,convertido))\n\n    return (final)\n}\n\n#cria grupos de faturamento\ncriaGrupodeFaturamento <- function (contatos, vendedor = \"all\", lead_source_geral = \"all\", lead_source = \"all\", type = \"safra\", ecommerce_platform = \"all\",\n                                dataRef = NULL, Q = NULL, dataFinal = NULL){\n  ## set vectors for all option ##\n  if (vendedor == \"all\"){\n    vendedor <- unique(contatos$hubspot_owner_name)\n  }\n  if (lead_source_geral == \"all\"){\n    lead_source_geral <- unique(contatos$lead_source_geral_new)\n  }\n  if (lead_source == \"all\"){\n    lead_source <- unique(contatos$lead_source_new)\n  }\n  if (ecommerce_platform == \"all\"){\n    ecommerce_platform <- unique(contatos$ecommerce_platform)\n  }\n  #arrange contacts dates\n  #contatosD <- suppressWarnings(arrangeDate (contatos))\n  contatosD <- contatos\n  ## visao do mes ##\n  if (type == \"mes\"){\n    if (is.null(dataRef)){\n      dataRef <- as.Date(paste(year(now()),\"-\",month(now()),\"-01\",sep=\"\"))\n    }else{\n      dataRef <- as.Date(paste(year(dataRef),\"-\",month(dataRef),\"-01\",sep=\"\"))\n    }\n\n    dataFinal <- as.Date(paste(year(dataRef),\"-\",month(dataRef)+1,\"-01\",sep=\"\"))\n\n    F0 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F0\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F1 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F1\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F2 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F2\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F3 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F3\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F4 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F4\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F5 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F5\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F6 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F6\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F7 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F7\") &\n                         contatos$deal_stage==\"Convertido\"))\n    ND <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         (is.na(contatosD$faturamento_grupo) |\n                         (contatosD$faturamento_grupo==\"\")) &\n                         contatos$deal_stage==\"Convertido\"))\n\n  }\n  ## visao de trimestral ##\n  else if (type == \"tri\"){\n\n    if (is.null(dataRef)){\n      if (is.null(Q)){\n        Q <- quarter(now())\n      }\n      if (Q == 1){\n        dataRef <- as.Date(paste(year(now()),\"-01-01\",sep=\"\"))\n      }else if (Q == 2){\n        dataRef <- as.Date(paste(year(now()),\"-04-01\",sep=\"\"))\n      }else if (Q == 3){\n        dataRef <- as.Date(paste(year(now()),\"-07-01\",sep=\"\"))\n      }else {\n        dataRef <- as.Date(paste(year(now()),\"-10-01\",sep=\"\"))\n      }\n    }\n    else if (!is.null(dataRef)){\n      if (is.null(Q)){\n        Q <- quarter(dataRef)\n      }\n      if (Q == 1){\n        dataRef <- as.Date(paste(year(dataRef),\"-01-01\",sep=\"\"))\n      }else if (Q == 2){\n        dataRef <- as.Date(paste(year(dataRef),\"-04-01\",sep=\"\"))\n      }else if (Q == 3){\n        dataRef <- as.Date(paste(year(dataRef),\"-07-01\",sep=\"\"))\n      }else {\n        dataRef <- as.Date(paste(year(dataRef),\"-10-01\",sep=\"\"))\n      }\n    }\n\n    dataFinal <- dataRef\n    month(dataFinal) <- month(dataRef) + 2\n    day(dataFinal) <- days_in_month(dataFinal)\n\n    F0 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F0\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F1 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F1\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F2 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F2\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F3 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F3\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F4 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F4\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F5 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F5\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F6 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F6\" &\n                         contatos$deal_stage==\"Convertido\"))\n    F7 <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform&\n                         contatosD$faturamento_grupo==\"F7\" &\n                         contatos$deal_stage==\"Convertido\"))\n    ND <- length(which(!is.na(contatosD$convertido_date) &\n                         (contatosD$convertido_date>=dataRef) &\n                         (contatosD$convertido_date<=dataFinal) &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         (is.na(contatosD$faturamento_grupo) |\n                            (contatosD$faturamento_grupo==\"\")) &\n                         contatos$deal_stage==\"Convertido\"))\n\n  }\n  ## visao de safra ##\n  else {\n    if (is.null(dataRef)){\n      dataRef <- as.Date(paste(year(now()),\"-01-01\",sep=\"\"))\n    }\n    if (is.null(dataFinal)){\n      dataFinal <- as.Date(paste(year(dataRef),\"-12-31\",sep=\"\"))\n    }\n\n    F0 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F0\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F1 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F1\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F2 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F2\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F3 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F3\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F4 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F4\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F5 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F5\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F6 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F6\") &\n                         contatos$deal_stage==\"Convertido\"))\n    F7 <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         !is.na(contatosD$faturamento_grupo) &\n                         (contatosD$faturamento_grupo==\"F7\") &\n                         contatos$deal_stage==\"Convertido\"))\n    ND <- length(which(!is.na(contatosD$reuniao_date) &\n                         contatosD$reuniao_date>=dataRef &\n                         contatosD$reuniao_date<=dataFinal &\n                         !is.na(contatosD$convertido_date) &\n                         contatosD$convertido_date>=dataRef &\n                         contatosD$convertido_date<=dataFinal &\n                         contatosD$hubspot_owner_name%in%vendedor &\n                         contatosD$lead_source_geral_new%in%lead_source_geral &\n                         contatosD$lead_source_new%in%lead_source &\n                         contatosD$ecommerce_platform%in%ecommerce_platform &\n                         (is.na(contatosD$faturamento_grupo) |\n                            (contatosD$faturamento_grupo==\"\")) &\n                         contatos$deal_stage==\"Convertido\"))\n  }\n\n  final <- data.frame(grupo_faturamento = c(\"NId\",\"F0\",\"F1\",\"F2\",\"F3\",\"F4\",\"F5\",\"F6\",\"F7\"),\n                      ncontacts = c(ND,F0,F1,F2,F3,F4,F5,F6,F7))\n\n  return (final)\n}\n\n#plota funil\nplotFunilComercial <- function(funil, title = \"Funil Comercial\",subtitle = \"\", color = \"#0000CC\", fill = \"steelblue\", complete = FALSE){\n  if (!complete){\n    funil <- funil[c(which(funil$deal_stage%in%c(\"Reuniao\",\"Proposta Enviada\",\"Proposta Aceita\",\"Convertido\"))),]\n  }\n  total <- funil[which(funil$deal_stage==\"Reuniao\"),which(names(funil)==\"ncontacts\")]\n  funil$padding <- (total - funil$ncontacts) / 2\n  funil$efficiency <- 100*funil$ncontacts/total\n  molten <- melt(funil[,-c(which(names(funil)==\"efficiency\"))], id.var='deal_stage')\n  molten <- molten[order(molten$variable, decreasing = T), ]\n  molten_deal_stage_levels <- c(\"Convertido\",\"Integrado\",\"Em Integracao\",\"Proposta Aceita\",\"Proposta Enviada\",\"Qualificado\",\"Primeiro Contato\",\"Reuniao\")\n  molten$deal_stage <- factor(molten$deal_stage, levels = molten_deal_stage_levels)\n  funil$deal_stage <- factor(funil$deal_stage, levels = molten_deal_stage_levels)\n\n  p1 <- ggplot(molten, aes(x=deal_stage)) +\n    geom_bar(aes(y = value, fill = variable),\n             stat='identity', position='stack') +\n    geom_text(data=funil,\n              aes(y=total/2, label= paste(ncontacts)),\n              color='white',size = 6) +\n    scale_fill_manual(values = c(color, NA) ) +\n    coord_flip() +\n    theme(legend.position = 'none',\n          axis.title.x=element_blank(),\n          axis.text.x=element_blank(),\n          axis.ticks.x=element_blank(),\n          axis.title.y=element_blank(),\n          axis.text.y = element_text(size = 15),\n          plot.margin = unit(c(0,0,0,0), \"cm\")) #cima,direita,baixo,esquerda\n\n  p2 <- ggplot(funil, aes(x=deal_stage, y=efficiency)) +\n    geom_bar(stat='identity',fill=fill) +\n    geom_text(aes(y = 15, label = paste(round(efficiency), '%',sep=\"\")),\n              color=\"white\",size = 6) +\n    scale_fill_manual(values = c(color)) +\n    coord_flip() +\n    theme(legend.position = 'none',\n          axis.title.x=element_blank(),\n          axis.text.x=element_blank(),\n          axis.ticks.x=element_blank(),\n          axis.title.y=element_blank(),\n          axis.text.y=element_blank(),\n          axis.ticks.y=element_blank(),\n          plot.margin = unit(c(0,0,0,-1), \"cm\"))\n\n\n  if (subtitle!=\"\"){\n    tg <- textGrob(paste(title,\" -\",subtitle), gp=gpar(fontsize=20))\n  }\n  else {\n    tg <- textGrob(paste(title), gp=gpar(fontsize=20))\n  }\n  grid.arrange(p1, p2, ncol=2, widths=c(4,1), top=tg)\n}\n\n#plota funil\nplotGruposdeFaturamento <- function(grupo_faturamento, title = \"Grupos de Faturamento\", color = \"Blues\"){\n  levels <- c(\"NId\",\"F0\",\"F1\",\"F2\",\"F3\",\"F4\",\"F5\",\"F6\",\"F7\")\n  grupo_faturamento$grupo_faturamento <- factor(grupo_faturamento$grupo_faturamento, levels = levels)\n  p<-ggplot(grupo_faturamento, aes(x=grupo_faturamento, y=ncontacts, fill=grupo_faturamento)) +\n    geom_bar(stat=\"identity\")+scale_fill_brewer(palette=color) +\n    geom_text(data=grupo_faturamento,\n              aes(y=ncontacts, label= paste(ncontacts),vjust=ifelse(ncontacts>0,1,0)),size = 5) +\n    theme(legend.position = 'none',\n          axis.title.x=element_blank(),\n          axis.ticks.x=element_blank(),\n          axis.title.y=element_blank(),\n          axis.text.x = element_text(size = 15),\n          axis.text.y = element_blank(),\n          plot.title = element_text(size=20)) +\n    ggtitle(title)\n  grid.arrange(p)\n\n}\n\n#filtra contatos\nfiltraContatos <- function (contatos, vendedor = \"all\", lead_source_geral = \"all\", lead_source = \"all\", type = \"safra\", ecommerce_platform = \"all\",\n                            dataRef = NULL, Q = NULL, dataFinal = NULL){\n  ## set vectors for all option ##\n  if (vendedor == \"all\"){\n    vendedor <- unique(contatos$hubspot_owner_name)\n  }\n  if (lead_source_geral == \"all\"){\n    lead_source_geral <- unique(contatos$lead_source_geral_new)\n  }\n  if (lead_source == \"all\"){\n    lead_source <- unique(contatos$lead_source_new)\n  }\n  if (ecommerce_platform == \"all\"){\n    ecommerce_platform <- unique(contatos$ecommerce_platform)\n  }\n  #arrange contacts dates\n  #contatosD <- suppressWarnings(arrangeDate (contatos))\n  contatosD <- contatos\n  ## visao do mes ##\n  if (type == \"mes\"){\n    if (is.null(dataRef)){\n      dataRef <- as.Date(paste(year(now()),\"-\",month(now()),\"-01\",sep=\"\"))\n    }else{\n      dataRef <- as.Date(paste(year(dataRef),\"-\",month(dataRef),\"-01\",sep=\"\"))\n    }\n\n    dataFinal <- as.Date(paste(year(dataRef),\"-\",month(dataRef)+1,\"-01\",sep=\"\"))\n\n    reuniao <- contatosD[(!is.na(contatosD$reuniao_date) &\n                              (contatosD$reuniao_date>=dataRef) &\n                              (contatosD$reuniao_date<dataFinal) &\n                              contatosD$hubspot_owner_name%in%vendedor &\n                              contatosD$lead_source_geral_new%in%lead_source_geral &\n                              contatosD$lead_source_new%in%lead_source &\n                              contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    pcontato <- contatosD[(!is.na(contatosD$prim_contato_date) &\n                               (contatosD$prim_contato_date>=dataRef) &\n                               (contatosD$prim_contato_date<dataFinal) &\n                               contatosD$hubspot_owner_name%in%vendedor &\n                               contatosD$lead_source_geral_new%in%lead_source_geral &\n                               contatosD$lead_source_new%in%lead_source &\n                               contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    qualificado <- contatosD[(!is.na(contatosD$qualificado_date) &\n                                  (contatosD$qualificado_date>=dataRef) &\n                                  (contatosD$qualificado_date<dataFinal) &\n                                  contatosD$hubspot_owner_name%in%vendedor &\n                                  contatosD$lead_source_geral_new%in%lead_source_geral &\n                                  contatosD$lead_source_new%in%lead_source &\n                                  contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    penviada <- contatosD[(!is.na(contatosD$prop_enviada_date) &\n                               (contatosD$prop_enviada_date>=dataRef) &\n                               (contatosD$prop_enviada_date<dataFinal) &\n                               contatosD$hubspot_owner_name%in%vendedor &\n                               contatosD$lead_source_geral_new%in%lead_source_geral &\n                               contatosD$lead_source_new%in%lead_source &\n                               contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    paceita <- contatosD[(!is.na(contatosD$prop_aceita_date) &\n                              (contatosD$prop_aceita_date>=dataRef) &\n                              (contatosD$prop_aceita_date<dataFinal) &\n                              contatosD$hubspot_owner_name%in%vendedor &\n                              contatosD$lead_source_geral_new%in%lead_source_geral &\n                              contatosD$lead_source_new%in%lead_source &\n                              contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    emintegracao <- contatosD[(!is.na(contatosD$em_integracao_date) &\n                                   (contatosD$em_integracao_date>=dataRef) &\n                                   (contatosD$em_integracao_date<dataFinal) &\n                                   contatosD$hubspot_owner_name%in%vendedor &\n                                   contatosD$lead_source_geral_new%in%lead_source_geral &\n                                   contatosD$lead_source_new%in%lead_source &\n                                   contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    integrado <- contatosD[(!is.na(contatosD$integrado_date) &\n                                (contatosD$integrado_date>=dataRef) &\n                                (contatosD$integrado_date<dataFinal) &\n                                contatosD$hubspot_owner_name%in%vendedor &\n                                contatosD$lead_source_geral_new%in%lead_source_geral &\n                                contatosD$lead_source_new%in%lead_source &\n                                contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    convertido <- contatosD[(!is.na(contatosD$convertido_date) &\n                                 (contatosD$convertido_date>=dataRef) &\n                                 (contatosD$convertido_date<dataFinal) &\n                                 contatosD$hubspot_owner_name%in%vendedor &\n                                 contatosD$lead_source_geral_new%in%lead_source_geral &\n                                 contatosD$lead_source_new%in%lead_source &\n                                 contatosD$ecommerce_platform%in%ecommerce_platform &\n                                 contatos$deal_stage==\"Convertido\"),]\n  }\n  ## visao de trimestral ##\n  else if (type == \"tri\"){\n\n    if (is.null(dataRef)){\n      if (is.null(Q)){\n        Q <- quarter(now())\n      }\n      if (Q == 1){\n        dataRef <- as.Date(paste(year(now()),\"-01-01\",sep=\"\"))\n      }else if (Q == 2){\n        dataRef <- as.Date(paste(year(now()),\"-04-01\",sep=\"\"))\n      }else if (Q == 3){\n        dataRef <- as.Date(paste(year(now()),\"-07-01\",sep=\"\"))\n      }else {\n        dataRef <- as.Date(paste(year(now()),\"-10-01\",sep=\"\"))\n      }\n    }\n    else if (!is.null(dataRef)){\n      if (is.null(Q)){\n        Q <- quarter(dataRef)\n      }\n      if (Q == 1){\n        dataRef <- as.Date(paste(year(dataRef),\"-01-01\",sep=\"\"))\n      }else if (Q == 2){\n        dataRef <- as.Date(paste(year(dataRef),\"-04-01\",sep=\"\"))\n      }else if (Q == 3){\n        dataRef <- as.Date(paste(year(dataRef),\"-07-01\",sep=\"\"))\n      }else {\n        dataRef <- as.Date(paste(year(dataRef),\"-10-01\",sep=\"\"))\n      }\n    }\n\n    dataFinal <- dataRef\n    month(dataFinal) <- month(dataRef) + 2\n    day(dataFinal) <- days_in_month(dataFinal)\n\n    reuniao <- contatosD[(!is.na(contatosD$reuniao_date) &\n                              (contatosD$reuniao_date>=dataRef) &\n                              (contatosD$reuniao_date<=dataFinal) &\n                              contatosD$hubspot_owner_name%in%vendedor &\n                              contatosD$lead_source_geral_new%in%lead_source_geral &\n                              contatosD$lead_source_new%in%lead_source &\n                              contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    pcontato <- contatosD[(!is.na(contatosD$prim_contato_date) &\n                               (contatosD$prim_contato_date>=dataRef) &\n                               (contatosD$prim_contato_date<=dataFinal) &\n                               contatosD$hubspot_owner_name%in%vendedor &\n                               contatosD$lead_source_geral_new%in%lead_source_geral &\n                               contatosD$lead_source_new%in%lead_source &\n                               contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    qualificado <- contatosD[(!is.na(contatosD$qualificado_date) &\n                                  (contatosD$qualificado_date>=dataRef) &\n                                  (contatosD$qualificado_date<=dataFinal) &\n                                  contatosD$hubspot_owner_name%in%vendedor &\n                                  contatosD$lead_source_geral_new%in%lead_source_geral &\n                                  contatosD$lead_source_new%in%lead_source &\n                                  contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    penviada <- contatosD[(!is.na(contatosD$prop_enviada_date) &\n                               (contatosD$prop_enviada_date>=dataRef) &\n                               (contatosD$prop_enviada_date<=dataFinal) &\n                               contatosD$hubspot_owner_name%in%vendedor &\n                               contatosD$lead_source_geral_new%in%lead_source_geral &\n                               contatosD$lead_source_new%in%lead_source &\n                               contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    paceita <- contatosD[(!is.na(contatosD$prop_aceita_date) &\n                              (contatosD$prop_aceita_date>=dataRef) &\n                              (contatosD$prop_aceita_date<=dataFinal) &\n                              contatosD$hubspot_owner_name%in%vendedor &\n                              contatosD$lead_source_geral_new%in%lead_source_geral &\n                              contatosD$lead_source_new%in%lead_source &\n                              contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    emintegracao <- contatosD[(!is.na(contatosD$em_integracao_date) &\n                                   (contatosD$em_integracao_date>=dataRef) &\n                                   (contatosD$em_integracao_date<=dataFinal) &\n                                   contatosD$hubspot_owner_name%in%vendedor &\n                                   contatosD$lead_source_geral_new%in%lead_source_geral &\n                                   contatosD$lead_source_new%in%lead_source &\n                                   contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    integrado <- contatosD[(!is.na(contatosD$integrado_date) &\n                                (contatosD$integrado_date>=dataRef) &\n                                (contatosD$integrado_date<=dataFinal) &\n                                contatosD$hubspot_owner_name%in%vendedor &\n                                contatosD$lead_source_geral_new%in%lead_source_geral &\n                                contatosD$lead_source_new%in%lead_source &\n                                contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    convertido <- contatosD[(!is.na(contatosD$convertido_date) &\n                                 (contatosD$convertido_date>=dataRef) &\n                                 (contatosD$convertido_date<=dataFinal) &\n                                 contatosD$hubspot_owner_name%in%vendedor &\n                                 contatosD$lead_source_geral_new%in%lead_source_geral &\n                                 contatosD$lead_source_new%in%lead_source &\n                                 contatosD$ecommerce_platform%in%ecommerce_platform &\n                                 contatos$deal_stage==\"Convertido\"),]\n\n  }\n  ## visao de safra ##\n  else {\n    if (is.null(dataRef)){\n      dataRef <- as.Date(paste(year(now()),\"-01-01\",sep=\"\"))\n    }\n    if (is.null(dataFinal)){\n      dataFinal <- as.Date(paste(year(dataRef),\"-12-31\",sep=\"\"))\n    }\n\n    reuniao <- contatosD[(!is.na(contatosD$reuniao_date) &\n                              contatosD$reuniao_date>=dataRef &\n                            contatosD$reuniao_date<=dataFinal &\n                              contatosD$hubspot_owner_name%in%vendedor &\n                              contatosD$lead_source_geral_new%in%lead_source_geral &\n                              contatosD$lead_source_new%in%lead_source &\n                              contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    pcontato <- contatosD[(!is.na(contatosD$reuniao_date) &\n                               contatosD$reuniao_date>=dataRef &\n                             contatosD$reuniao_date<=dataFinal &\n                               !is.na(contatosD$prim_contato_date) &\n                             contatosD$prim_contato_date>=dataRef &\n                             contatosD$prim_contato_date<=dataFinal &\n                               contatosD$hubspot_owner_name%in%vendedor &\n                               contatosD$lead_source_geral_new%in%lead_source_geral &\n                               contatosD$lead_source_new%in%lead_source &\n                               contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    qualificado <- contatosD[(!is.na(contatosD$reuniao_date) &\n                                  contatosD$reuniao_date>=dataRef &\n                                contatosD$reuniao_date<=dataFinal &\n                                  !is.na(contatosD$qualificado_date) &\n                                contatosD$qualificado_date>=dataRef &\n                                contatosD$qualificado_date<=dataFinal &\n                                  contatosD$hubspot_owner_name%in%vendedor &\n                                  contatosD$lead_source_geral_new%in%lead_source_geral &\n                                  contatosD$lead_source_new%in%lead_source &\n                                  contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    penviada <- contatosD[(!is.na(contatosD$reuniao_date) &\n                               contatosD$reuniao_date>=dataRef &\n                             contatosD$reuniao_date<=dataFinal &\n                               !is.na(contatosD$prop_enviada_date) &\n                             contatosD$prop_enviada_date>=dataRef &\n                             contatosD$prop_enviada_date<=dataFinal &\n                               contatosD$hubspot_owner_name%in%vendedor &\n                               contatosD$lead_source_geral_new%in%lead_source_geral &\n                               contatosD$lead_source_new%in%lead_source &\n                               contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    paceita <- contatosD[(!is.na(contatosD$reuniao_date) &\n                              contatosD$reuniao_date>=dataRef &\n                            contatosD$reuniao_date<=dataFinal &\n                              !is.na(contatosD$prop_aceita_date) &\n                            contatosD$prop_aceita_date>=dataRef &\n                            contatosD$prop_aceita_date<=dataFinal &\n                              contatosD$hubspot_owner_name%in%vendedor &\n                              contatosD$lead_source_geral_new%in%lead_source_geral &\n                              contatosD$lead_source_new%in%lead_source &\n                              contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    emintegracao <- contatosD[(!is.na(contatosD$reuniao_date) &\n                                   contatosD$reuniao_date>=dataRef &\n                                 contatosD$reuniao_date<=dataFinal &\n                                   !is.na(contatosD$em_integracao_date) &\n                                 contatosD$em_integracao_date>=dataRef &\n                                 contatosD$em_integracao_date<=dataFinal &\n                                   contatosD$hubspot_owner_name%in%vendedor &\n                                   contatosD$lead_source_geral_new%in%lead_source_geral &\n                                   contatosD$lead_source_new%in%lead_source &\n                                   contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    integrado <- contatosD[(!is.na(contatosD$reuniao_date) &\n                                contatosD$reuniao_date>=dataRef &\n                              contatosD$reuniao_date<=dataFinal &\n                                !is.na(contatosD$integrado_date) &\n                              contatosD$integrado_date>=dataRef &\n                              contatosD$integrado_date<=dataFinal &\n                                contatosD$hubspot_owner_name%in%vendedor &\n                                contatosD$lead_source_geral_new%in%lead_source_geral &\n                                contatosD$lead_source_new%in%lead_source &\n                                contatosD$ecommerce_platform%in%ecommerce_platform),]\n\n    convertido <- contatosD[(!is.na(contatosD$reuniao_date) &\n                                 contatosD$reuniao_date>=dataRef &\n                               contatosD$reuniao_date<=dataFinal &\n                                 !is.na(contatosD$convertido_date) &\n                               contatosD$convertido_date>=dataRef &\n                               contatosD$convertido_date<=dataFinal &\n                                 contatosD$hubspot_owner_name%in%vendedor &\n                                 contatosD$lead_source_geral_new%in%lead_source_geral &\n                                 contatosD$lead_source_new%in%lead_source &\n                                 contatosD$ecommerce_platform%in%ecommerce_platform &\n                                 contatos$deal_stage==\"Convertido\"),]\n  }\n\n  reuniao$estagio <- \"Reuniao\"\n  pcontato$estagio <- \"Primeiro Contato\"\n  qualificado$estagio <- \"Qualificado\"\n  penviada$estagio <- \"Proposta Enviada\"\n  paceita$estagio <- \"Proposta Aceita\"\n  emintegracao$estagio <- \"Em Integracao\"\n  integrado$estagio <- \"Integrado\"\n  convertido$estagio <- \"Convertido\"\n  final <- rbind(reuniao,pcontato,qualificado,penviada,paceita,emintegracao,integrado,convertido)\n\n  return (final)\n}\n\n#format contacts csv\nformatContactcsv <- function(contacts) {\n  contacts$opp_new_date<-as.Date(contacts$opp_new_date)\n  contacts$became_customer_new<- as.Date(contacts$became_customer_new)\n  contacts$reuniao_date<- as.Date(contacts$reuniao_date)\n  contacts$prim_contato_date<-as.Date(contacts$prim_contato_date)\n  contacts$qualificado_date<-as.Date(contacts$qualificado_date)\n  contacts$prop_enviada_date<-as.Date(contacts$prop_enviada_date)\n  contacts$prop_aceita_date<- as.Date(contacts$prop_aceita_date)\n  contacts$em_integracao_date<-as.Date(contacts$em_integracao_date)\n  contacts$integrado_date<-as.Date(contacts$integrado_date)\n  contacts$convertido_date<-as.Date(contacts$convertido_date)\n  contacts$nao_e_pra_agora_date<-as.Date(contacts$nao_e_pra_agora_date)\n  contacts$perdido_date<-as.Date(contacts$perdido_date)\n  contacts$hs_lifecyclestage_lead_date<-as.Date(contacts$hs_lifecyclestage_lead_date)\n  contacts$hs_lifecyclestage_marketingqualifiedlead_date<-as.Date(contacts$hs_lifecyclestage_marketingqualifiedlead_date)\n  contacts$lastmodifieddate<-as.Date(contacts$lastmodifieddate)\n  contacts$account_id<-as.numeric(contacts$account_id)\n  contacts$hubspotscore<-as.numeric(contacts$hubspotscore)\n  contacts$receita_ano<-as.numeric(contacts$receita_ano)\n  contacts$receita_mes<-as.numeric(contacts$receita_mes)\n  contacts$receita_total<-as.numeric(contacts$receita_total)\n  contacts$total_tpv<-as.numeric(contacts$total_tpv)\n  contacts$tpv_ano<-as.numeric(contacts$tpv_ano)\n  contacts$tpv_anteontem<-as.numeric(contacts$tpv_anteontem)\n  contacts$tpv_ontem<-as.numeric(contacts$tpv_ontem)\n  contacts$tpv_max<-as.numeric(contacts$tpv_max)\n  contacts$tpv_mes<-as.numeric(contacts$tpv_mes)\n  contacts$tpv_mes_1<-as.numeric(contacts$tpv_mes_1)\n  contacts$tpv_mes_2<-as.numeric(contacts$tpv_mes_2)\n  contacts$tpv_mes_3<-as.numeric(contacts$tpv_mes_3)\n}\n",
    "created" : 1500308690242.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "14|40|89|0|\n92|30|110|0|\n113|37|178|0|\n244|76|538|0|\n262|23|335|4|\n542|76|913|0|\n916|136|968|0|\n971|105|988|0|\n992|72|1293|0|\n1296|40|1326|0|\n",
    "hash" : "3985711791",
    "id" : "8360488B",
    "lastKnownWriteTime" : 1500399246,
    "last_content_update" : 1500399246281,
    "path" : "~/hubspotAPI/R/apiHubspot.R",
    "project_path" : "R/apiHubspot.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}